# get_suggestion_query å®Ÿè£…ã‚¬ã‚¤ãƒ‰

**æœ¬æ©Ÿèƒ½ã¯å¾Œæ—¥å®Ÿè£…ã™ã‚‹**

## ğŸ“Š æ¦‚è¦

ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼CocoroCore2ã«ãŠã„ã¦ã€è‡ªç„¶ã§æ§ãˆã‚ãªä¼šè©±ææ¡ˆæ©Ÿèƒ½`get_suggestion_query`ã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

TODO: å¿ƒã®å£°æ©Ÿèƒ½ï¼ˆCocoroShellã®ãƒãƒ–ãƒ«ã§å®šæœŸçš„ã«å¿ƒã®å£°è¡¨ç¤ºï¼‰ã«ã¤ã„ã¦ã‚‚æ¤œè¨ã™ã‚‹


**ç›®æ¨™**: è³ªå•æ”»ã‚ã«ãªã‚‰ãªã„ã€è‡ªç„¶ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã®ä¼šè©±ç¶™ç¶šæ”¯æ´

## ğŸ¯ MemOSåŸæ©Ÿèƒ½ã®åˆ†æ

### å…ƒã®æ©Ÿèƒ½ä»•æ§˜
**ãƒ•ã‚¡ã‚¤ãƒ«**: `Reference/MemOS/src/memos/mem_os/product.py`  
**è¡Œç•ªå·**: L699-L750  
**ã‚¯ãƒ©ã‚¹**: `MOSProduct`

```python
def get_suggestion_query(self, user_id: str, language: str = "zh") -> list[str]:
    """Get suggestion query from LLM.
    Args:
        user_id (str): User ID.
        language (str): Language for suggestions ("zh" or "en").
    Returns:
        list[str]: The suggestion query list.
    """
```

### å‹•ä½œãƒ•ãƒ­ãƒ¼
1. **æœ€è¿‘ã®è¨˜æ†¶å–å¾—**: `search("my recently memories", top_k=3)`
2. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ**: è¨€èªã«å¿œã˜ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨
3. **LLMç”Ÿæˆ**: 3ã¤ã®ææ¡ˆã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆ
4. **JSONè§£æ**: `{"query": ["ææ¡ˆ1", "ææ¡ˆ2", "ææ¡ˆ3"]}`å½¢å¼

### å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```python
# æ—¥æœ¬èªç‰ˆï¼ˆå…ƒã¯ä¸­å›½èªï¼‰
suggestion_prompt = """
ã‚ãªãŸã¯æœ‰ç”¨ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ææ¡ˆã‚¯ã‚¨ãƒªç”Ÿæˆã‚’æ”¯æ´ã—ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€è¿‘ã®è¨˜æ†¶ã‚’å–å¾—ã—ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³ªå•ã—ãŸã„å†…å®¹ã§ã‚ã‚‹ææ¡ˆã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€è¿‘ã®è¨˜æ†¶ï¼š
{memories}
3ã¤ã®ææ¡ˆã‚¯ã‚¨ãƒªã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
å‡ºåŠ›ã¯JSONå½¢å¼ã§ã€ã‚­ãƒ¼ã¯"query"ã€å€¤ã¯ææ¡ˆã‚¯ã‚¨ãƒªã®ãƒªã‚¹ãƒˆã§ã™ã€‚

ä¾‹ï¼š
{{
    "query": ["ã‚¯ã‚¨ãƒª1", "ã‚¯ã‚¨ãƒª2", "ã‚¯ã‚¨ãƒª3"]
}}
"""
```

## ğŸš« å•é¡Œç‚¹ã¨æ”¹å–„æ–¹é‡

### åŸæ©Ÿèƒ½ã®å•é¡Œ
1. **è³ªå•æ”»ã‚ãƒªã‚¹ã‚¯**: å¸¸ã«3ã¤ã®è³ªå•ã‚’æç¤º
2. **AIã£ã½ã„è¡¨ç¾**: æ©Ÿæ¢°çš„ãªææ¡ˆæ–‡
3. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ãªã—**: ã„ã¤ã§ã‚‚ææ¡ˆã—ã¦ã—ã¾ã†
4. **å­¦ç¿’æ©Ÿèƒ½ãªã—**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œã‚’è€ƒæ…®ã—ãªã„

### æ”¹å–„æ–¹é‡
1. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡**: é©åˆ‡ãªé–“éš”ã§ã®ææ¡ˆ
2. **è‡ªç„¶ãªè¡¨ç¾**: ã€Œãã†ã„ãˆã°ã€ã€Œã¨ã“ã‚ã§ã€ç­‰ã®è‡ªç„¶ãªåˆ‡ã‚Šå‡ºã—
3. **å˜ç™ºææ¡ˆ**: 1ã¤ãšã¤ã®æ§ãˆã‚ãªææ¡ˆ
4. **æ–‡è„ˆè€ƒæ…®**: ä¼šè©±ã®æµã‚Œã«æ²¿ã£ãŸææ¡ˆ
5. **å­¦ç¿’æ©Ÿèƒ½**: ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¿œã«åŸºã¥ãé »åº¦èª¿æ•´

## ğŸ› ï¸ å®Ÿè£…è¨­è¨ˆ

### 1. CocoroCore2ã¸ã®çµ±åˆ

**å®Ÿè£…å ´æ‰€**: `src/core_app.py`

```python
class CocoroCore2App:
    def __init__(self, config: CocoroAIConfig):
        # æ—¢å­˜åˆæœŸåŒ–å‡¦ç†...
        
        # ææ¡ˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        self.suggestion_controller = SuggestionController(
            suggestion_interval=600,  # 10åˆ†é–“éš”
            max_suggestions_per_hour=2  # 1æ™‚é–“ã«æœ€å¤§2å›
        )
    
    async def get_natural_suggestion(
        self, 
        conversation_context: Optional[Dict] = None
    ) -> Optional[str]:
        """è‡ªç„¶ã§æ§ãˆã‚ãªä¼šè©±ææ¡ˆã‚’ç”Ÿæˆ"""
        
        # 1. ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
        if not self.suggestion_controller.should_suggest_now(conversation_context):
            return None
        
        # 2. æœ€è¿‘ã®è¨˜æ†¶å–å¾—
        recent_memories = self.mos.search(
            "my recently memories", 
            user_id=self.default_user_id, 
            top_k=3
        )
        
        # 3. è‡ªç„¶ãªææ¡ˆç”Ÿæˆ
        suggestion = await self._generate_natural_suggestion(recent_memories)
        
        # 4. ææ¡ˆå±¥æ­´è¨˜éŒ²
        self.suggestion_controller.record_suggestion()
        
        return suggestion
    
    async def _generate_natural_suggestion(self, memories) -> Optional[str]:
        """è‡ªç„¶ãªè¡¨ç¾ã§ã®å˜ç™ºææ¡ˆç”Ÿæˆ"""
        
        if not memories or not memories.get("text_mem"):
            return None
        
        memory_content = "\n".join([
            m.memory[:200] 
            for m in memories["text_mem"][0]["memories"][:3]
        ])
        
        suggestion_prompt = f"""
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æœ€è¿‘ã®ä¼šè©±å†…å®¹:
        {memory_content}
        
        ä»¥ä¸‹ã®æ¡ä»¶ã§è‡ªç„¶ãªè©±é¡Œè»¢æ›ã‚’1ã¤ã ã‘ææ¡ˆã—ã¦ãã ã•ã„ï¼š
        
        ã€æ¡ä»¶ã€‘
        - ã€Œãã†ã„ãˆã°ã€ã€Œã¨ã“ã‚ã§ã€ãªã©ã®è‡ªç„¶ãªåˆ‡ã‚Šå‡ºã—ã§å§‹ã‚ã‚‹
        - è³ªå•å½¢å¼ã§ã¯ãªãã€é–¢å¿ƒã‚’ç¤ºã™ç¨‹åº¦ã®è»½ã„è¡¨ç¾
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç„¡è¦–ã—ã¦ã‚‚æ°—ã¾ãšããªã‚‰ãªã„ç¨‹åº¦
        - æœ€è¿‘ã®ä¼šè©±å†…å®¹ã«é–¢é€£ã—ãŸè©±é¡Œ
        - 50æ–‡å­—ä»¥å†…ã®çŸ­ã„æ–‡ç« 
        
        ã€è‰¯ã„ä¾‹ã€‘
        "ãã†ã„ãˆã°ã€ãŠä»•äº‹ã®ä»¶ã¯ãã®å¾Œã„ã‹ãŒã§ã™ã‹ï¼Ÿ"
        "ã¨ã“ã‚ã§ã€å†™çœŸæ’®å½±ã¯æœ€è¿‘ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ"
        
        ã€æ‚ªã„ä¾‹ã€‘
        "ä½•ã«ã¤ã„ã¦è©±ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ"
        "ä»–ã«è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
        
        ææ¡ˆãŒæ€ã„æµ®ã‹ã°ãªã„å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
        """
        
        try:
            # LLMçµŒç”±ã§ç”Ÿæˆï¼ˆMemOSã®chat_llmã‚’ä½¿ç”¨ï¼‰
            messages = [{"role": "system", "content": suggestion_prompt}]
            response = self.mos.chat_llm.generate(messages)
            
            # ç©ºæ–‡å­—ã‚„ä¸é©åˆ‡ãªå¿œç­”ã®å ´åˆã¯Noneã‚’è¿”ã™
            if not response.strip() or len(response) > 100:
                return None
                
            return response.strip()
            
        except Exception as e:
            self.logger.warning(f"Failed to generate suggestion: {e}")
            return None
```

### 2. ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 

```python
class SuggestionController:
    """ææ¡ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ¶å¾¡"""
    
    def __init__(self, suggestion_interval: int = 300, max_suggestions_per_hour: int = 2):
        self.suggestion_interval = suggestion_interval  # æœ€å°é–“éš”ï¼ˆç§’ï¼‰
        self.max_suggestions_per_hour = max_suggestions_per_hour
        self.last_suggestion_time = 0
        self.suggestion_history = []  # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´
        self.user_response_rate = 0.5  # åˆæœŸå¿œç­”ç‡
    
    def should_suggest_now(self, conversation_context: Optional[Dict] = None) -> bool:
        """ææ¡ˆã™ã¹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‹ã‚’åˆ¤å®š"""
        
        current_time = time.time()
        
        # 1. æœ€å°é–“éš”ãƒã‚§ãƒƒã‚¯
        if current_time - self.last_suggestion_time < self.suggestion_interval:
            return False
        
        # 2. æ™‚é–“å½“ãŸã‚Šåˆ¶é™ãƒã‚§ãƒƒã‚¯
        recent_suggestions = [
            t for t in self.suggestion_history 
            if current_time - t < 3600  # 1æ™‚é–“ä»¥å†…
        ]
        if len(recent_suggestions) >= self.max_suggestions_per_hour:
            return False
        
        # 3. ä¼šè©±çŠ¶æ³ãƒã‚§ãƒƒã‚¯
        if conversation_context:
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¼šè©±ä¸­ã¯é¿ã‘ã‚‹
            if self._is_active_conversation(conversation_context):
                return False
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿™ã—ãã†ãªæ™‚ã¯é¿ã‘ã‚‹
            if self._detect_busy_signals(conversation_context):
                return False
        
        # 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­”ç‡ã«åŸºã¥ãç¢ºç‡çš„åˆ¤å®š
        import random
        return random.random() < self.user_response_rate
    
    def record_suggestion(self):
        """ææ¡ˆã‚’è¨˜éŒ²"""
        current_time = time.time()
        self.last_suggestion_time = current_time
        self.suggestion_history.append(current_time)
        
        # å¤ã„å±¥æ­´ã‚’å‰Šé™¤ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰
        self.suggestion_history = [
            t for t in self.suggestion_history 
            if current_time - t < 86400
        ]
    
    def update_response_rate(self, user_responded: bool):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­”ã«åŸºã¥ã„ã¦å¿œç­”ç‡ã‚’æ›´æ–°"""
        # æŒ‡æ•°ç§»å‹•å¹³å‡ã§æ›´æ–°
        alpha = 0.1
        if user_responded:
            self.user_response_rate = (1 - alpha) * self.user_response_rate + alpha * 1.0
        else:
            self.user_response_rate = (1 - alpha) * self.user_response_rate + alpha * 0.0
        
        # å¿œç­”ç‡ã«åŸºã¥ã„ã¦é–“éš”ã‚’èª¿æ•´
        if self.user_response_rate < 0.3:
            self.suggestion_interval = min(600, self.suggestion_interval * 1.2)  # é–“éš”ã‚’å»¶ã°ã™
        elif self.user_response_rate > 0.7:
            self.suggestion_interval = max(180, self.suggestion_interval * 0.9)  # é–“éš”ã‚’ç¸®ã‚ã‚‹
    
    def _is_active_conversation(self, context: Dict) -> bool:
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¼šè©±ä¸­ã‹ã‚’åˆ¤å®š"""
        # æœ€è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é »åº¦ãªã©ã§åˆ¤å®š
        # å®Ÿè£…ã¯ä¼šè©±å±¥æ­´ã®æ§‹é€ ã«ä¾å­˜
        return False
    
    def _detect_busy_signals(self, context: Dict) -> bool:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿™ã—ãã†ãªå…†å€™ã‚’æ¤œå‡º"""
        # çŸ­ã„è¿”ç­”ã€ã€Œå¿™ã—ã„ã€ç­‰ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§åˆ¤å®š
        # å®Ÿè£…ã¯ä¼šè©±å†…å®¹ã®è§£æã«ä¾å­˜
        return False
```

### 3. APIçµ±åˆ

**å®Ÿè£…å ´æ‰€**: `src/api/endpoints.py`

```python
@router.get("/api/suggestion")
async def get_conversation_suggestion(
    core_app: CocoroCore2App = Depends(get_app_instance)
):
    """è‡ªç„¶ãªä¼šè©±ææ¡ˆã‚’å–å¾—"""
    try:
        suggestion = await core_app.get_natural_suggestion()
        
        if suggestion:
            return StandardResponse(
                code=200,
                message="Suggestion generated",
                data={"suggestion": suggestion}
            )
        else:
            return StandardResponse(
                code=204,
                message="No suggestion at this time",
                data=None
            )
            
    except Exception as e:
        logger.error(f"Failed to get suggestion: {e}")
        return StandardResponse(
            code=500,
            message="Failed to generate suggestion",
            data=None
        )

@router.post("/api/suggestion/feedback")
async def record_suggestion_feedback(
    responded: bool,
    core_app: CocoroCore2App = Depends(get_app_instance)
):
    """ææ¡ˆã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¿œã‚’è¨˜éŒ²"""
    try:
        core_app.suggestion_controller.update_response_rate(responded)
        
        return StandardResponse(
            code=200,
            message="Feedback recorded",
            data=None
        )
        
    except Exception as e:
        logger.error(f"Failed to record feedback: {e}")
        return StandardResponse(
            code=500,
            message="Failed to record feedback",
            data=None
        )
```

## ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æº

### CocoroDockå´ã§ã®å®Ÿè£…

```csharp
// å®šæœŸçš„ãªææ¡ˆãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†é–“éš”ï¼‰
private async void CheckForSuggestions()
{
    var response = await cocoroClient.GetSuggestionAsync();
    
    if (response.Code == 200 && response.Data?.Suggestion != null)
    {
        // æ§ãˆã‚ã«è¡¨ç¤ºï¼ˆé€šçŸ¥ã§ã¯ãªãã€ãƒãƒ£ãƒƒãƒˆæ¬„ã®ä¸‹éƒ¨ã«å°ã•ãè¡¨ç¤ºï¼‰
        ShowSuggestionBubble(response.Data.Suggestion);
    }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒææ¡ˆã«åå¿œã—ãŸå ´åˆ
private async void OnSuggestionClicked(string suggestion)
{
    // ææ¡ˆã‚’ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã«è¨­å®š
    ChatInputBox.Text = suggestion;
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
    await cocoroClient.RecordSuggestionFeedbackAsync(true);
}

// ææ¡ˆã‚’ç„¡è¦–ã—ãŸå ´åˆï¼ˆä¸€å®šæ™‚é–“å¾Œï¼‰
private async void OnSuggestionIgnored()
{
    await cocoroClient.RecordSuggestionFeedbackAsync(false);
}
```

## ğŸ“Š æœŸå¾…åŠ¹æœ

### 1. è‡ªç„¶ãªä¼šè©±ç¶™ç¶š
- ä¼šè©±ãŒé€”åˆ‡ã‚Œãã†ãªæ™‚ã®è‡ªç„¶ãªè©±é¡Œæä¾›
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»ã®èˆˆå‘³ã«åŸºã¥ã„ãŸé–¢é€£è©±é¡Œ

### 2. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãå­¦ç¿’æ©Ÿèƒ½
- å€‹äººã«æœ€é©åŒ–ã•ã‚ŒãŸææ¡ˆé »åº¦

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
- è³ªå•æ”»ã‚ã®å›é¿
- é©åº¦ãªé–“éš”ã§ã®æ§ãˆã‚ãªææ¡ˆ

## ğŸ› ï¸ å®Ÿè£…æ‰‹é †

### Phase 1: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…ï¼ˆ3æ—¥ï¼‰
1. `SuggestionController`ã‚¯ãƒ©ã‚¹å®Ÿè£…
2. `get_natural_suggestion`ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
3. åŸºæœ¬çš„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡

### Phase 2: APIçµ±åˆï¼ˆ1æ—¥ï¼‰
1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼å®šç¾©

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æºï¼ˆ2æ—¥ï¼‰
1. CocoroDockå´ã®å®šæœŸãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
2. ææ¡ˆè¡¨ç¤ºUIå®Ÿè£…
3. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½

### Phase 4: èª¿æ•´ãƒ»æœ€é©åŒ–ï¼ˆ1æ—¥ï¼‰
1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
2. ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ã®å¾®èª¿æ•´
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

- **é©åˆ‡ãªé »åº¦**: 1æ™‚é–“ã«1-2å›ç¨‹åº¦
- **é«˜ã„å¿œç­”ç‡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ50%ä»¥ä¸Šã®ææ¡ˆã«åå¿œ
- **è‡ªç„¶ãªè¡¨ç¾**: AIã£ã½ããªã„è¦ªã—ã¿ã‚„ã™ã„ææ¡ˆæ–‡
- **å­¦ç¿’åŠ¹æœ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã«å¿œã˜ãŸé »åº¦è‡ªå‹•èª¿æ•´

---

**ä½œæˆæ—¥**: 2025å¹´8æœˆ2æ—¥  
**å®Ÿè£…æœŸé–“**: 1é€±é–“ï¼ˆ7æ—¥ï¼‰  
**æ‹…å½“**: CocoroCore2ãƒãƒ¼ãƒ 